--- # node weight tracker app definition
- hosts: webservers
  become: yes
  vars_files:
    - vault.yml
  tasks:
    - name: get nodejs installation
      get_url:
          url: https://deb.nodesource.com/setup_14.x
          dest: node-weight-tracker/nodesource_setup.sh
          mode: 0764

    - name: run nodejs setup configuration file
      become: yes
      ansible.builtin.shell: bash nodesource_setup.sh
      args:
        chdir: "node-weight-tracker/"

    - name: install nodejs
      apt:
        name: nodejs
        state: present

    - name: project initialization
      become: yes
      ansible.builtin.shell: npm init -y
      args:
        chdir: "node-weight-tracker/"

    - name: app dependencies installation
      shell:
         cmd: |
           npm install @hapi/hapi@19 @hapi/bell@12 @hapi/boom@9 @hapi/cookie@11 @hapi/inert@6 @hapi/joi@17 @hapi/vision@6 dotenv@8 ejs@3 postgres@1 -y
           npm install --save-dev nodemon@2 -y

    - name: get public IP for env
      community.general.ipify_facts:
        timeout: 20

    - name: create env file
      copy:
        dest: "node-weight-tracker/.env"
        content: |
          # Host configuration
          PORT=8080
          HOST=localhost
          NODE_ENV=development
          HOST_URL=http://{{ ipify_public_ip }}:8080
          COOKIE_ENCRYPT_PWD=superAwesomePasswordStringThatIsAtLeast32CharactersLong!

          # Okta configuration
          OKTA_ORG_URL=https://{{ domain }}
          OKTA_CLIENT_ID={{ clientid }}
          OKTA_CLIENT_SECRET={{ secret }}

          # Postgres configuration
          PGHOST={{ servername }}
          PGUSERNAME=postgres@{{ servername }}
          PGDATABASE=postgres
          PGPASSWORD={{ password }}
          PGPORT=5432

    - name: DB initialization
      ansible.builtin.shell: npm run initdb
      args:
        chdir: "node-weight-tracker/"

    - name: pm2 to make process run after restart
      shell:
         cmd: |
           sudo npm install pm2@latest -g
           sudo pm2 start npm -- run dev
           sudo pm2 save
           sudo pm2 startup
      args:
        chdir: "node-weight-tracker/"